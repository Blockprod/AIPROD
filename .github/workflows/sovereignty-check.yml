# =============================================================================
# AIPROD Sovereignty Check — CI/CD Pipeline
# =============================================================================
# Exécuté à chaque push/PR pour valider que le projet reste 100% souverain.
# Les tests sont exécutés en mode réseau bloqué (air-gapped).
# =============================================================================

name: Sovereignty Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  sovereignty-tests:
    name: "Sovereignty Tests (Air-Gapped)"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies (sovereign only)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pyyaml

      - name: Install AIPROD packages
        run: |
          pip install packages/aiprod-core
          pip install packages/aiprod-trainer
          pip install packages/aiprod-pipelines

      - name: Run sovereignty tests
        run: |
          pytest tests/test_sovereignty.py -v --tb=short

      - name: Verify no cloud imports in core
        run: |
          # Vérifier qu'aucun import cloud n'est actif dans aiprod-core
          if grep -rn "^from google\|^import google\|^from openai\|^import openai\|^from anthropic\|^import anthropic\|^from boto3\|^import boto3" \
            packages/aiprod-core/src/ --include="*.py"; then
            echo "❌ FAIL: Cloud imports found in aiprod-core"
            exit 1
          fi
          echo "✅ PASS: No cloud imports in aiprod-core"

      - name: Verify all from_pretrained have local_files_only
        run: |
          python -c "
          from pathlib import Path
          violations = []
          for f in Path('packages').rglob('*.py'):
              lines = f.read_text(errors='ignore').split('\n')
              for i, line in enumerate(lines, 1):
                  if 'from_pretrained(' in line and 'local_files_only' not in line:
                      ctx = '\n'.join(lines[i-1:i+3])
                      if 'local_files_only' not in ctx:
                          violations.append(f'{f}:{i}')
          if violations:
              print('❌ from_pretrained without local_files_only:')
              for v in violations: print(f'  {v}')
              exit(1)
          print('✅ All from_pretrained calls use local_files_only')
          "

  core-tests:
    name: "Core Tests (Regression)"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pyyaml

      - name: Install AIPROD packages
        run: |
          pip install packages/aiprod-core
          pip install packages/aiprod-trainer
          pip install packages/aiprod-pipelines

      - name: Run core tests
        run: |
          pytest tests/test_aiprod_core_components.py \
                 tests/test_aiprod_core_types.py \
                 tests/test_aiprod_trainer_curriculum.py \
                 tests/test_aiprod_trainer_vae.py \
                 -v --tb=short

      - name: Run Phase 3 training tests
        run: |
          pytest tests/test_phase3_training.py -v --tb=short

  docker-build:
    name: "Docker Build Verification"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Dockerfile sovereignty
        run: |
          # Vérifier que les Dockerfiles ne contiennent pas de dépendances cloud actives
          for df in deploy/docker/Dockerfile deploy/docker/Dockerfile.gpu; do
            if grep -v "^#" "$df" | grep -q "google-cloud-storage\|boto3\|stripe"; then
              echo "❌ FAIL: Cloud packages found in $df"
              exit 1
            fi
          done
          echo "✅ PASS: Dockerfiles are sovereign"
